{% extends "base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h3>ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</h3>
    </div>
</div>

<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="row g-4 mb-4">
    <!-- æ€»ç”¨æˆ·æ•° -->
    <div class="col-md-3">
        <div class="card p-3 border-start border-4 border-primary shadow-sm h-100">
            <div class="text-muted small text-uppercase fw-bold">æ€»ç”¨æˆ·æ•°</div>
            <div class="h2 text-primary mt-2" id="stat-users">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            </div>
        </div>
    </div>

    <!-- æ€»æ”¶å…¥ -->
    <div class="col-md-3">
        <div class="card p-3 border-start border-4 border-success shadow-sm h-100">
            <div class="text-muted small text-uppercase fw-bold">æ€»æ”¶å…¥ (USDT)</div>
            <div class="h2 text-success mt-2" id="stat-revenue">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            </div>
        </div>
    </div>

    <!-- åœ¨çº¿ç›‘å¬è´¦å· -->
    <div class="col-md-3">
        <div class="card p-3 border-start border-4 border-warning shadow-sm h-100">
            <div class="text-muted small text-uppercase fw-bold">åœ¨çº¿ç›‘å¬è´¦å·</div>
            <div class="h2 text-warning mt-2" id="stat-bots">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            </div>
        </div>
    </div>

    <!-- ä»Šæ—¥æ¶ˆæ¯æ•è· -->
    <div class="col-md-3">
        <div class="card p-3 border-start border-4 border-info shadow-sm h-100">
            <div class="text-muted small text-uppercase fw-bold">ä»Šæ—¥æ¶ˆæ¯æ•è· (æ¡)</div>
            <div class="h2 text-info mt-2" id="stat-msgs">
                <div class="spinner-border spinner-border-sm text-secondary" role="status"></div>
            </div>
        </div>
    </div>
</div>

<!-- å®æ—¶æ—¥å¿— -->
<div class="card shadow-sm">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <span><i class="fas fa-terminal me-2"></i> å®æ—¶ç³»ç»Ÿæ—¥å¿— (Worker & System)</span>
        <span class="badge bg-success" id="log-status">Live</span>
    </div>
    <div class="card-body bg-black p-0">
        <div id="log-container" style="height: 400px; overflow-y: auto; padding: 15px; font-family: 'Consolas', 'Monaco', monospace; font-size: 0.85rem; color: #0f0; background-color: #1e1e1e;">
            <div class="text-muted">æ­£åœ¨è¿æ¥æ—¥å¿—æµ...</div>
        </div>
    </div>
</div>

<script>
    // 1. è·å–ç»Ÿè®¡æ•°æ®
    async function fetchStats() {
        try {
            const res = await fetch('/api/dashboard/stats');
            const data = await res.json();
            
            // ç®€å•çš„åŠ¨ç”»æ•ˆæœå‡½æ•°
            updateNumber('stat-users', data.users);
            updateNumber('stat-revenue', data.revenue.toFixed(2));
            
            const botText = `${data.bots_online} / ${data.bots_total}`;
            document.getElementById('stat-bots').innerText = botText;
            
            updateNumber('stat-msgs', data.msgs_today);
            
        } catch (e) {
            console.error("Stats fetch error", e);
        }
    }

    function updateNumber(elementId, newValue) {
        const el = document.getElementById(elementId);
        // ç®€å•å¤„ç†ï¼Œå¦‚æœå†…å®¹ä¸æ˜¯æ•°å­—ï¼ˆæ¯”å¦‚æ˜¯åŠ è½½å›¾æ ‡ï¼‰ï¼Œç›´æ¥æ›¿æ¢
        if (el.querySelector('.spinner-border')) {
            el.innerText = newValue;
        } else {
            el.innerText = newValue;
        }
    }

    // 2. è·å–æ—¥å¿—
    async function fetchLogs() {
        try {
            const res = await fetch('/api/dashboard/logs');
            const data = await res.json();
            
            const container = document.getElementById('log-container');
            
            if (data.logs && data.logs.length > 0) {
                // æ¸…ç©ºå¹¶é‡æ–°å¡«å…… (ç®€å•ç²—æš´ï¼Œé˜²æ­¢é‡å¤)
                // ç”Ÿäº§ç¯å¢ƒé€šå¸¸ç”¨ appendï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºç®€å•ç›´æ¥è¦†ç›–
                const logHtml = data.logs.map(line => {
                    // ç»™å…³é”®è¯ä¸Šè‰²
                    let color = '#ccc'; // é»˜è®¤ç°è‰²
                    if (line.includes('INFO')) color = '#4caf50'; // ç»¿è‰²
                    if (line.includes('WARNING')) color = '#ff9800'; // æ©™è‰²
                    if (line.includes('ERROR')) color = '#f44336'; // çº¢è‰²
                    if (line.includes('Worker')) color = '#2196f3'; // è“è‰²
                    
                    return `<div style="margin-bottom: 4px; color: ${color}; border-bottom: 1px solid #333; padding-bottom: 2px;">${line}</div>`;
                }).join('');
                
                container.innerHTML = logHtml;
            }
        } catch (e) {
            document.getElementById('log-status').className = 'badge bg-danger';
            document.getElementById('log-status').innerText = 'Offline';
        }
    }

    // åˆå§‹åŒ–
    fetchStats();
    fetchLogs();

    // å®šæ—¶åˆ·æ–° (æ¯3ç§’åˆ·æ–°æ—¥å¿—ï¼Œæ¯5ç§’åˆ·æ–°ç»Ÿè®¡)
    setInterval(fetchLogs, 3000);
    setInterval(fetchStats, 5000);

</script>
{% endblock %}