{% extends "base.html" %}
{% block content %}
<div class="card mb-4 shadow-sm">
    <div class="card-body d-flex justify-content-between align-items-center">
        <h4 class="mb-0">ğŸ‘¤ ç”¨æˆ·ç®¡ç†</h4>
        <div class="input-group w-25">
            <input type="text" class="form-control" id="searchQ" placeholder="æœç´¢ ID/ç”¨æˆ·å">
            <button class="btn btn-outline-primary" onclick="searchUser()">æœç´¢</button>
        </div>
    </div>
</div>

<div class="card mb-4 shadow-sm">
    <div class="card-header bg-light d-flex justify-content-between align-items-center">
        <span>å·²é€‰ä¸­ <strong id="sel-count">0</strong> äºº</span>
        <div class="btn-group">
            <button class="btn btn-sm btn-success" onclick="broadcast()"><i class="fas fa-bullhorn"></i> ç¾¤å‘æ¶ˆæ¯</button>
            <button class="btn btn-sm btn-danger" onclick="banUsers('ban')"><i class="fas fa-ban"></i> æ‹‰é»‘</button>
            <button class="btn btn-sm btn-secondary" onclick="banUsers('unban')"><i class="fas fa-unlock"></i> è§£å°</button>
        </div>
    </div>
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th width="40"><input type="checkbox" onclick="toggleAll(this)"></th>
                    <th>TG ID</th>
                    <th>ç”¨æˆ·å</th>
                    <th>èº«ä»½</th>
                    <th>åˆ°æœŸæ—¶é—´</th>
                    <th>çŠ¶æ€</th>
                </tr>
            </thead>
            <tbody id="userTable">
                <!-- JS å¡«å…… -->
            </tbody>
        </table>
    </div>
</div>

<div class="card shadow-sm p-3 bg-light">
    <h5>âš™ï¸ æ–°ç”¨æˆ·ç­–ç•¥ (åŠŸèƒ½6)</h5>
    <div class="row align-items-center g-2">
        <div class="col-auto">æ–°ç”¨æˆ·é¦–æ¬¡ä½¿ç”¨å…è´¹è¯•ç”¨ï¼š</div>
        <div class="col-auto"><input type="number" id="trialHours" class="form-control" value="2" style="width: 80px;"></div>
        <div class="col-auto">å°æ—¶</div>
        <div class="col-auto"><button class="btn btn-primary btn-sm" onclick="saveTrial()">ä¿å­˜è®¾ç½®</button></div>
    </div>
</div>

<script>
// æœç´¢ä¸åŠ è½½
async function searchUser() {
    const q = document.getElementById('searchQ').value;
    const res = await fetch(`/api/users/search?q=${q}`);
    const users = await res.json();
    renderUsers(users);
}

function renderUsers(users) {
    const tbody = document.getElementById('userTable');
    tbody.innerHTML = users.map(u => `
        <tr>
            <td><input type="checkbox" class="u-check" value="${u.id}" onchange="updateCount()"></td>
            <td>${u.tg_id}</td>
            <td>${u.username || '-'}</td>
            <td><span class="badge ${u.role=='vip'?'bg-warning text-dark':'bg-secondary'}">${u.role}</span></td>
            <td>${u.expire_at ? new Date(u.expire_at).toLocaleString() : 'æ°¸ä¹…/æœªæ¿€æ´»'}</td>
            <td>${u.is_banned ? '<span class="badge bg-danger">å°ç¦</span>' : '<span class="badge bg-success">æ­£å¸¸</span>'}</td>
        </tr>
    `).join('');
    updateCount();
}

// é€‰ä¸­é€»è¾‘
function toggleAll(source) {
    document.querySelectorAll('.u-check').forEach(c => c.checked = source.checked);
    updateCount();
}
function updateCount() {
    const n = document.querySelectorAll('.u-check:checked').length;
    document.getElementById('sel-count').innerText = n;
}
function getSelectedIds() {
    return Array.from(document.querySelectorAll('.u-check:checked')).map(c => parseInt(c.value));
}

// ç¾¤å‘
async function broadcast() {
    const ids = getSelectedIds();
    if(ids.length === 0) return alert("è¯·å…ˆé€‰æ‹©ç”¨æˆ·");
    const text = prompt("è¯·è¾“å…¥è¦ç¾¤å‘çš„æ¶ˆæ¯å†…å®¹ï¼š");
    if(!text) return;

    const res = await fetch('/api/users/broadcast', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_ids: ids, text: text})
    });
    alert(`å‘é€ä»»åŠ¡å·²æäº¤ï¼ŒæˆåŠŸæ¨é€åˆ° ${(await res.json()).sent} äºº`);
}

// æ‹‰é»‘/è§£å°
async function banUsers(action) {
    const ids = getSelectedIds();
    if(ids.length === 0) return alert("è¯·å…ˆé€‰æ‹©ç”¨æˆ·");
    if(!confirm(`ç¡®å®šè¦ ${action=='ban'?'æ‹‰é»‘':'è§£å°'} é€‰ä¸­çš„ ${ids.length} åç”¨æˆ·å—ï¼Ÿ`)) return;

    await fetch('/api/users/ban', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({user_ids: ids, action: action})
    });
    searchUser(); // åˆ·æ–°
}

// ä¿å­˜ç­–ç•¥
async function saveTrial() {
    const val = document.getElementById('trialHours').value;
    await fetch('/api/settings/trial', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({key: 'trial_hours', value: val})
    });
    alert("ç­–ç•¥å·²ä¿å­˜");
}

searchUser(); // åˆå§‹åŠ è½½
</script>
{% endblock %}