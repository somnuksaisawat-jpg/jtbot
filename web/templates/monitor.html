{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>ğŸ“¢ å¹¿å‘Šä¸èœå•é…ç½®</h3>
</div>

<ul class="nav nav-tabs mb-4" id="monitorTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="menu-tab" data-bs-toggle="tab" data-bs-target="#menu" type="button">
            <i class="fas fa-th-large me-2"></i> æœºå™¨äººä¸»èœå•
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="ads-tab" data-bs-toggle="tab" data-bs-target="#ads" type="button">
            <i class="fas fa-ad me-2"></i> æ¶ˆæ¯åº•éƒ¨å¹¿å‘Š
        </button>
    </li>
</ul>

<div class="tab-content" id="monitorTabContent">
    
    <!-- Tab 1: èœå•ä¸é…ç½® -->
    <div class="tab-pane fade show active" id="menu">
        <div class="row">
            <!-- å·¦ä¾§é¢„è§ˆ -->
            <div class="col-md-4">
                <div class="card bg-light">
                    <div class="card-header text-center">ğŸ“± æœºå™¨äººç•Œé¢é¢„è§ˆ</div>
                    <div class="card-body p-2">
                        <div class="bg-white p-3 rounded mb-2 shadow-sm">ğŸ‘‹ æ¬¢è¿ä½¿ç”¨ç›‘æ§æœºå™¨äºº...</div>
                        <!-- è¿™é‡Œå±•ç¤ºåº•éƒ¨ Reply é”®ç›˜çš„æ•ˆæœé¢„è§ˆ -->
                        <div class="d-grid gap-2 mt-3">
                            <div class="btn-group w-100"><button class="btn btn-secondary btn-sm disabled">âš™ï¸ ç›‘å¬ç®¡ç†</button></div>
                            <div class="btn-group w-100"><button class="btn btn-secondary btn-sm disabled">ğŸ”” é€šçŸ¥æ§åˆ¶</button></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§é…ç½® -->
            <div class="col-md-8">
                
                <!-- 1. èŠå¤©åº•éƒ¨å¸¸é©»èœå•é…ç½® (Reply) -->
                <div class="card border-warning mb-4">
                    <div class="card-header bg-warning text-dark d-flex justify-content-between">
                        <span><i class="fas fa-keyboard"></i> èŠå¤©åº•éƒ¨å¸¸é©»èœå• (Reply Keyboard)</span>
                        <button class="btn btn-sm btn-dark" onclick="saveReplyMenu()">ä¿å­˜å¹¶ç”Ÿæ•ˆ</button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light small p-2 mb-3">
                            è®¾ç½®èŠå¤©çª—å£ä¸‹æ–¹çš„å¤§æŒ‰é’®ã€‚<br>
                            <b>è§¦å‘åŠ¨ä½œ (Callback)ï¼š</b> è¯·å¡«å†™å¯¹åº”çš„åŠŸèƒ½ä»£ç ï¼Œä¾‹å¦‚ <code>buy_vip</code>ã€‚
                        </div>
                        <table class="table table-sm align-middle">
                            <thead><tr><th width="60">è¡Œ</th><th>æŒ‰é’®æ–‡å­—</th><th>è§¦å‘åŠ¨ä½œ (Callback)</th><th width="50">åˆ </th></tr></thead>
                            <tbody id="replyTableBody"></tbody>
                        </table>
                        <button class="btn btn-dashed w-100 text-muted mt-2 border" onclick="addReplyRow()">+ æ·»åŠ æŒ‰é’®</button>
                    </div>
                </div>

                <!-- 2. å¿«æ·è¯é…ç½® -->
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between">
                        <span>ğŸ·ï¸ å¿«æ·å…³é”®è¯ç®¡ç† (èŠå¤©æ¡†ä¸‹æ–¹)</span>
                        <button class="btn btn-sm btn-success" onclick="savePresetsList()">ä¿å­˜</button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-light small p-2 mb-2">è¿™äº›è¯ä¼šåœ¨ç”¨æˆ·ç‚¹å‡»â€œæ·»åŠ å…³é”®è¯â€æ—¶å¼¹å‡ºï¼Œæ–¹ä¾¿ç‚¹é€‰ã€‚</div>
                        <div id="presetsContainer" class="d-flex flex-wrap gap-2"></div>
                        <div class="input-group mt-3">
                            <input type="text" class="form-control form-control-sm" id="newPresetInput" placeholder="è¾“å…¥æ–°è¯ (ä¾‹å¦‚: è·‘åˆ†)">
                            <button class="btn btn-outline-secondary btn-sm" onclick="addPresetTag()">æ·»åŠ </button>
                        </div>
                    </div>
                </div>

                <!-- 3. å·¦ä¸‹è§’èœå•æŒ‰é’®è®¾ç½® -->
                <div class="card border-info mb-4">
                    <div class="card-header bg-info text-white d-flex justify-content-between">
                        <span><i class="fas fa-bars"></i> å·¦ä¸‹è§’æŒ‡ä»¤èœå• (Menu Button)</span>
                        <button class="btn btn-sm btn-light text-dark" onclick="saveCommands()">æ›´æ–°åˆ°æœºå™¨äºº</button>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm align-middle">
                            <thead><tr><th width="30%">æŒ‡ä»¤ (e.g. menu)</th><th>æè¿° (e.g. æ‰“å¼€èœå•)</th><th width="50">åˆ </th></tr></thead>
                            <tbody id="cmdTableBody"></tbody>
                        </table>
                        <button class="btn btn-dashed w-100 text-muted mt-2 border" onclick="addCmdRow()">+ æ·»åŠ æŒ‡ä»¤</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Tab 2: å¹¿å‘Š -->
    <div class="tab-pane fade" id="ads">
        <div class="card">
            <div class="card-header d-flex justify-content-between">
                <span>ğŸ“£ æ¶ˆæ¯åº•éƒ¨å¹¿å‘ŠæŒ‰é’®</span>
                <button class="btn btn-sm btn-success" onclick="saveAds()">ä¿å­˜å¹¿å‘Šè®¾ç½®</button>
            </div>
            <div class="card-body">
                <table class="table table-bordered table-sm align-middle">
                    <thead><tr><th width="50">åº</th><th>æ–‡å­—</th><th>é“¾æ¥</th><th width="50">åˆ </th></tr></thead>
                    <tbody id="adsTableBody"></tbody>
                </table>
                <button class="btn btn-outline-secondary w-100 btn-sm" onclick="addAdRow()">+ æ·»åŠ ä¸€è¡Œ</button>
            </div>
        </div>
    </div>
</div>

<script>
// --- é€šç”¨å‡½æ•° ---
function createDelBtn(onclick) {
    return `<button class="btn btn-sm text-danger" onclick="${onclick}"><i class="fas fa-trash"></i></button>`;
}

// 1. [æ–°å¢] èŠå¤©åº•éƒ¨å¸¸é©»èœå• (Reply Menu)
async function loadReplyMenu() {
    try {
        const res = await fetch('/api/settings/reply_menus');
        const items = await res.json();
        const tbody = document.getElementById('replyTableBody');
        tbody.innerHTML = '';
        if(!items || items.length===0) { addReplyRow(1, 'âš™ï¸ ç›‘å¬ç®¡ç†', 'menu_monitor'); }
        else { items.forEach(i => addReplyRow(i.row_index, i.text, i.callback)); }
    } catch(e){}
}
function addReplyRow(r=1, t='', c='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `
        <td><input type="number" class="form-control form-control-sm r-row" value="${r}"></td>
        <td><input type="text" class="form-control form-control-sm r-text" value="${t}"></td>
        <td><input type="text" class="form-control form-control-sm r-call" value="${c}" placeholder="callback"></td>
        <td>${createDelBtn("this.closest('tr').remove()")}</td>
    `;
    document.getElementById('replyTableBody').appendChild(tr);
}
async function saveReplyMenu() {
    const items = []; document.querySelectorAll('#replyTableBody tr').forEach(tr => items.push({row: parseInt(tr.querySelector('.r-row').value), text: tr.querySelector('.r-text').value, callback: tr.querySelector('.r-call').value}));
    await fetch('/api/settings/reply_menus', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({items}) });
    alert("âœ… åº•éƒ¨èœå•å·²ä¿å­˜ï¼å‘é€ /menu æŸ¥çœ‹æ•ˆæœã€‚");
}

// 2. å¿«æ·è¯ (Tags)
async function loadPresets() {
    try {
        const res = await fetch('/api/settings/presets_list');
        const words = await res.json();
        const div = document.getElementById('presetsContainer');
        div.innerHTML = '';
        words.forEach(w => renderPresetTag(w));
    } catch(e){}
}
function renderPresetTag(word) {
    const span = document.createElement('span');
    span.className = "badge bg-secondary p-2 d-flex align-items-center gap-2";
    span.innerHTML = `${word} <i class="fas fa-times" onclick="this.parentElement.remove()" style="cursor:pointer"></i>`;
    document.getElementById('presetsContainer').appendChild(span);
}
function addPresetTag() {
    const input = document.getElementById('newPresetInput');
    const val = input.value.trim();
    if(val) { renderPresetTag(val); input.value = ''; }
}
async function savePresetsList() {
    const words = []; document.querySelectorAll('#presetsContainer span').forEach(s => words.push({word: s.innerText.trim()}));
    await fetch('/api/settings/presets_list', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({words}) });
    alert("âœ… å¿«æ·è¯å·²ä¿å­˜");
}

// 3. å·¦ä¸‹è§’æŒ‡ä»¤ (Menu Button)
async function loadCommands() {
    try {
        const res = await fetch('/api/settings/commands');
        const cmds = await res.json();
        const tbody = document.getElementById('cmdTableBody');
        tbody.innerHTML = '';
        if(!cmds || cmds.length===0) { addCmdRow('menu', 'æ‰“å¼€èœå•'); }
        else { cmds.forEach(c => addCmdRow(c.command, c.description)); }
    } catch(e){}
}
function addCmdRow(c='', d='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><div class="input-group input-group-sm"><span class="input-group-text">/</span><input type="text" class="form-control c-cmd" value="${c}"></div></td><td><input type="text" class="form-control form-control-sm c-desc" value="${d}"></td><td>${createDelBtn("this.closest('tr').remove()")}</td>`;
    document.getElementById('cmdTableBody').appendChild(tr);
}
async function saveCommands() {
    const cmds = []; document.querySelectorAll('#cmdTableBody tr').forEach(tr => cmds.push({ command: tr.querySelector('.c-cmd').value, description: tr.querySelector('.c-desc').value }));
    const btn = event.target; btn.disabled=true; btn.innerText='åŒæ­¥ä¸­...';
    try {
        await fetch('/api/settings/commands', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({commands: cmds}) });
        alert("âœ… æŒ‡ä»¤å·²åŒæ­¥ï¼");
    } finally { btn.disabled=false; btn.innerText='æ›´æ–°åˆ°æœºå™¨äºº'; }
}

// 4. å¹¿å‘Š
async function loadAds() {
    try {
        const res = await fetch('/api/settings/ads');
        const ads = await res.json();
        const tbody = document.getElementById('adsTableBody');
        tbody.innerHTML = '';
        ads.forEach(ad => addAdRow(ad.sort_order, ad.text, ad.url));
    } catch(e){}
}
function addAdRow(s=0, t='', u='') {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td><input type="number" class="form-control form-control-sm a-sort" value="${s}"></td><td><input type="text" class="form-control form-control-sm a-text" value="${t}"></td><td><input type="text" class="form-control form-control-sm a-url" value="${u}"></td><td>${createDelBtn("this.closest('tr').remove()")}</td>`;
    document.getElementById('adsTableBody').appendChild(tr);
}
async function saveAds() {
    const ads = []; document.querySelectorAll('#adsTableBody tr').forEach(tr => ads.push({sort_order: parseInt(tr.querySelector('.a-sort').value), text: tr.querySelector('.a-text').value, url: tr.querySelector('.a-url').value}));
    await fetch('/api/settings/ads', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ads}) });
    alert("âœ… å¹¿å‘Šå·²ä¿å­˜");
}

// åˆå§‹åŒ–åŠ è½½ (åˆ é™¤äº† loadMenu å’Œ loadSupport)
loadReplyMenu(); loadPresets(); loadCommands(); loadAds();
</script>
{% endblock %}