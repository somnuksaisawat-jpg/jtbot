{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h3>âœˆï¸ æ™ºèƒ½ç§ä¿¡çŸ©é˜µ (ç‹¬ç«‹ç³»ç»Ÿ)</h3>
    <span class="badge bg-primary fs-6">å½“å‰å¯ç”¨ç§¯åˆ†: <span id="creditDisplay">åŠ è½½ä¸­...</span></span>
</div>

<ul class="nav nav-tabs mb-4" id="dmTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#accounts">
            <i class="fas fa-users"></i> è´¦å·çŸ©é˜µ (å‘é€ç«¯)
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#templates">
            <i class="fas fa-comment-dots"></i> è¯æœ¯ä¸æ¨¡æ¿
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#logs">
            <i class="fas fa-history"></i> å‘é€æ—¥å¿—
        </button>
    </li>
</ul>

<div class="tab-content">
    
    <!-- 1. è´¦å·ç®¡ç† -->
    <div class="tab-pane fade show active" id="accounts">
        <div class="row">
            <div class="col-md-4">
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">ğŸ“¤ ä¸Šä¼  Tdata (æ¨è)</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label small">è¯·å°† tdata æ–‡ä»¶å¤¹å‹ç¼©ä¸º .zip ä¸Šä¼ </label>
                            <input class="form-control" type="file" id="tdataFile" accept=".zip">
                        </div>
                        <div class="mb-3">
                            <label class="form-label small">SOCKS5 ä»£ç† (é€‰å¡«)</label>
                            <input class="form-control" type="text" id="proxyUrl" placeholder="user:pass@ip:port">
                        </div>
                        <button class="btn btn-success w-100" onclick="uploadTdata()" id="btnUpload">
                            <i class="fas fa-upload"></i> å¼€å§‹è½¬æ¢å¹¶å¯¼å…¥
                        </button>
                        <div id="uploadStatus" class="mt-2 text-center small text-muted"></div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">è´¦å·æ± çŠ¶æ€</div>
                    <div class="card-body p-0">
                        <table class="table table-striped align-middle mb-0">
                            <thead><tr><th>æ‰‹æœºå·</th><th>çŠ¶æ€</th><th>ä»Šæ—¥/é™é¢</th><th>ä»£ç†</th><th>æ“ä½œ</th></tr></thead>
                            <tbody id="accTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 2. æ¨¡æ¿ç®¡ç† -->
    <div class="tab-pane fade" id="templates">
        <div class="card mb-3">
            <div class="card-body">
                <form id="tplForm" class="row g-2 align-items-center">
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="tName" placeholder="æ¨¡æ¿åç§°">
                    </div>
                    <div class="col-md-2">
                        <select class="form-select" id="tType">
                            <option value="text">çº¯æ–‡æœ¬</option>
                            <option value="photo">å›¾ç‰‡+æ–‡å­—</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="tContent" placeholder="ç§ä¿¡å†…å®¹">
                    </div>
                    <div class="col-md-2">
                        <input type="text" class="form-control" id="tTrigger" placeholder="è§¦å‘å…³é”®è¯(é€‰å¡«)">
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-primary w-100" onclick="saveTemplate()">ä¿å­˜æ¨¡æ¿</button>
                    </div>
                </form>
            </div>
        </div>
        
        <table class="table table-bordered">
            <thead><tr><th>åç§°</th><th>ç±»å‹</th><th>å†…å®¹</th><th>è‡ªåŠ¨å›å¤è§¦å‘è¯</th><th>æ“ä½œ</th></tr></thead>
            <tbody id="tplTable"></tbody>
        </table>
    </div>

    <!-- 3. æ—¥å¿— (æš‚ç•¥ï¼Œåç»­å¼€å‘) -->
    <div class="tab-pane fade" id="logs">
        <div class="alert alert-info">ä»»åŠ¡æ—¥å¿—æ¨¡å—å°†åœ¨ä¸‹ä¸€é˜¶æ®µä¸Šçº¿ã€‚</div>
    </div>
</div>

<script>
// --- è´¦å·ç›¸å…³ ---
async function loadAccounts() {
    const res = await fetch('/api/dm/accounts');
    const list = await res.json();
    document.getElementById('accTable').innerHTML = list.map(a => `
        <tr>
            <td>${a.phone}</td>
            <td><span class="badge ${a.status=='ready'?'bg-success':'bg-danger'}">${a.status}</span></td>
            <td>${a.daily_sent} / ${a.daily_limit}</td>
            <td>${a.proxy_url ? 'âœ…' : 'âŒ'}</td>
            <td><button class="btn btn-sm btn-outline-danger" onclick="delAccount(${a.id})">åˆ é™¤</button></td>
        </tr>
    `).join('');
}

async function uploadTdata() {
    const file = document.getElementById('tdataFile').files[0];
    if(!file) return alert("è¯·é€‰æ‹© ZIP æ–‡ä»¶");
    
    const btn = document.getElementById('btnUpload');
    const status = document.getElementById('uploadStatus');
    
    const formData = new FormData();
    formData.append("file", file);
    formData.append("proxy", document.getElementById('proxyUrl').value);
    
    btn.disabled = true;
    btn.innerText = "æ­£åœ¨è§£æ Tdata...";
    status.innerText = "æ­£åœ¨ä¸Šä¼ å¹¶è½¬æ¢æ ¼å¼ï¼Œè¯·å‹¿å…³é—­é¡µé¢...";
    
    try {
        const res = await fetch('/api/dm/upload_tdata', { method: 'POST', body: formData });
        const data = await res.json();
        if(data.status === 'success') {
            alert(data.message);
            loadAccounts();
        } else {
            alert("é”™è¯¯: " + data.detail);
        }
    } catch(e) {
        alert("ä¸Šä¼ å¤±è´¥: " + e);
    } finally {
        btn.disabled = false;
        btn.innerText = "å¼€å§‹è½¬æ¢å¹¶å¯¼å…¥";
        status.innerText = "";
    }
}

async function delAccount(id) {
    if(!confirm("ç¡®å®šåˆ é™¤?")) return;
    await fetch('/api/dm/accounts/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})});
    loadAccounts();
}

// --- æ¨¡æ¿ç›¸å…³ ---
async function loadTemplates() {
    const res = await fetch('/api/dm/templates');
    const list = await res.json();
    document.getElementById('tplTable').innerHTML = list.map(t => `
        <tr>
            <td>${t.name}</td>
            <td>${t.content_type}</td>
            <td>${t.text_content.substring(0,30)}...</td>
            <td>${t.trigger_keywords || '-'}</td>
            <td><button class="btn btn-sm btn-danger" onclick="delTemplate(${t.id})">åˆ </button></td>
        </tr>
    `).join('');
}

async function saveTemplate() {
    await fetch('/api/dm/templates', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
        name: document.getElementById('tName').value,
        content_type: document.getElementById('tType').value,
        text_content: document.getElementById('tContent').value,
        trigger: document.getElementById('tTrigger').value
    })});
    loadTemplates();
}

async function delTemplate(id) {
    await fetch('/api/dm/templates/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})});
    loadTemplates();
}

// Init
loadAccounts();
loadTemplates();
</script>
{% endblock %}