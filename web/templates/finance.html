{% extends "base.html" %}
{% block content %}
<div class="row">
    <!-- å·¦ä¾§ï¼šå¡å¯†ç”Ÿæˆ (ä¿ç•™) -->
    <div class="col-md-5">
        <div class="card h-100 shadow-sm">
            <div class="card-header bg-white"><i class="fas fa-ticket-alt text-primary"></i> ç”Ÿæˆå……å€¼å¡å¯†</div>
            <div class="card-body">
                <form id="genForm">
                    <div class="mb-3">
                        <label>ç±»å‹</label>
                        <select class="form-select" id="cdkType">
                            <option value="day">å¤©å¡ (Days)</option>
                            <option value="hour">å°æ—¶å¡ (Hours)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label>æ—¶é•¿æ•°å€¼</label>
                        <input type="number" class="form-control" id="cdkValue" placeholder="å¦‚ 30">
                    </div>
                    <div class="mb-3">
                        <label>ç”Ÿæˆæ•°é‡</label>
                        <input type="number" class="form-control" id="cdkCount" value="10">
                    </div>
                    <button type="button" class="btn btn-success w-100" onclick="generateCDK()">
                        <i class="fas fa-file-export"></i> ç”Ÿæˆå¹¶å¯¼å‡º TXT
                    </button>
                </form>
                <hr>
                <h6 class="text-muted">æœ€è¿‘ç”Ÿæˆçš„å¡å¯†</h6>
                <div class="table-responsive" style="max-height: 200px;">
                    <table class="table table-sm table-striped" style="font-size: 0.85rem;">
                        <thead><tr><th>ä»£ç </th><th>æ—¶é•¿</th><th>çŠ¶æ€</th></tr></thead>
                        <tbody id="cdkTable"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šæ”¯ä»˜é…ç½® & å¥—é¤ç®¡ç† -->
    <div class="col-md-7">
        <!-- 1. æ”¶æ¬¾é…ç½® -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white"><i class="fas fa-wallet text-warning"></i> USDT-TRC20 æ”¶æ¬¾è®¾ç½®</div>
            <div class="card-body">
                <div class="input-group mb-2">
                    <span class="input-group-text">æ”¶æ¬¾åœ°å€</span>
                    <input type="text" class="form-control" id="usdtAddr" value="{{ config.usdt_address }}">
                </div>
                <div class="input-group mb-2">
                    <span class="input-group-text">æ±‡ç‡(CNY)</span>
                    <input type="number" class="form-control" id="usdtRate" value="7.3">
                </div>
                <button class="btn btn-primary btn-sm w-100" onclick="savePayment()">ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <!-- 2. å¥—é¤ç®¡ç† -->
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <span><i class="fas fa-list"></i> ä¼šå‘˜å¥—é¤é…ç½®</span>
                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addPlanModal">+ æ·»åŠ å¥—é¤</button>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light"><tr><th>åç§°</th><th>ä»·æ ¼(U)</th><th>æ—¶é•¿</th><th>æ’åº</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="planTable"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ å¥—é¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="addPlanModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">æ·»åŠ ä¼šå‘˜å¥—é¤</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <div class="mb-2"><label>å¥—é¤åç§°</label><input type="text" class="form-control" id="pName" placeholder="ä¾‹å¦‚: æœˆå¡"></div>
                <div class="mb-2"><label>ä»·æ ¼ (USDT)</label><input type="number" class="form-control" id="pPrice" placeholder="15"></div>
                <div class="row g-2 mb-2">
                    <div class="col-8"><label>æ—¶é•¿æ•°å€¼</label><input type="number" class="form-control" id="pDur" placeholder="30"></div>
                    <div class="col-4"><label>å•ä½</label><select class="form-select" id="pUnit"><option value="day">å¤©</option><option value="month">æœˆ</option><option value="year">å¹´</option></select></div>
                </div>
                <div class="mb-2"><label>æ’åº (è¶Šå°è¶Šå‰)</label><input type="number" class="form-control" id="pSort" value="0"></div>
            </div>
            <div class="modal-footer"><button class="btn btn-primary" onclick="addPlan()">ä¿å­˜</button></div>
        </div>
    </div>
</div>

<script>
// --- å¡å¯†é€»è¾‘ (ä¿æŒ) ---
async function generateCDK() {
    const type=document.getElementById('cdkType').value, value=document.getElementById('cdkValue').value, count=document.getElementById('cdkCount').value;
    const res = await fetch('/api/finance/cdks/generate', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({type,value,count})});
    const data = await res.json();
    if(data.status==='success'){
        const blob = new Blob([data.codes.join('\n')], {type:"text/plain"});
        const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`CDK_${value}.txt`; a.click();
        loadCDKs();
    }
}
async function loadCDKs() {
    const res = await fetch('/api/finance/cdks');
    document.getElementById('cdkTable').innerHTML = (await res.json()).map(r=>`<tr><td><code>${r.code}</code></td><td>${r.duration}${r.unit}</td><td><span class="badge ${r.status=='unused'?'bg-success':'bg-secondary'}">${r.status}</span></td></tr>`).join('');
}

// --- æ”¯ä»˜é…ç½®é€»è¾‘ ---
async function savePayment() {
    await fetch('/api/settings/payment', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
        usdt_address: document.getElementById('usdtAddr').value,
        usdt_rate: parseFloat(document.getElementById('usdtRate').value),
        monthly_price: 0 // åºŸå¼ƒå­—æ®µï¼Œç•™0
    })});
    alert("ä¿å­˜æˆåŠŸ");
}

// ... (å‰é¢çš„ä»£ç ä¿æŒä¸å˜) ...

// --- å¥—é¤ç®¡ç†é€»è¾‘ (ä¿®æ”¹äº†å•ä½æ˜¾ç¤º) ---
async function loadPlans() {
    const res = await fetch('/api/finance/plans');
    const rows = await res.json();
    
    // ğŸŸ¢ [ä¿®æ”¹] å•ä½è½¬ä¸­æ–‡æ˜ å°„
    const unitMap = { 'day': 'å¤©', 'month': 'æœˆ', 'year': 'å¹´', 'hour': 'å°æ—¶' };
    
    document.getElementById('planTable').innerHTML = rows.map(r => `
        <tr>
            <td>${r.name}</td>
            <td class="text-success fw-bold">${r.price} U</td>
            <td>${r.duration} ${unitMap[r.unit] || r.unit}</td>
            <td>${r.sort_order}</td>
            <td><button class="btn btn-sm text-danger" onclick="delPlan(${r.id})"><i class="fas fa-trash"></i></button></td>
        </tr>
    `).join('');
}

// ... (åé¢çš„ä»£ç ä¿æŒä¸å˜) ...
async function addPlan() {
    await fetch('/api/finance/plans', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({
        name: document.getElementById('pName').value,
        price: parseFloat(document.getElementById('pPrice').value),
        duration: parseInt(document.getElementById('pDur').value),
        unit: document.getElementById('pUnit').value,
        sort_order: parseInt(document.getElementById('pSort').value)
    })});
    location.reload();
}
async function delPlan(id) {
    if(confirm('ç¡®å®šåˆ é™¤?')) {
        await fetch('/api/finance/plans/delete', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({id})});
        loadPlans();
    }
}

// Init
loadCDKs(); loadPlans();
</script>
{% endblock %}