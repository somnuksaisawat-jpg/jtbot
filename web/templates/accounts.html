{% extends "base.html" %}
{% block content %}
<ul class="nav nav-tabs mb-4" id="myTab" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" id="worker-tab" data-bs-toggle="tab" data-bs-target="#worker" type="button">ğŸ›° ç›‘å¬è´¦å·æ±  (ç³»ç»Ÿ)</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" id="dm-tab" data-bs-toggle="tab" data-bs-target="#dm" type="button">ğŸ“© ç§ä¿¡è´¦å· (ç”¨æˆ·)</button>
    </li>
</ul>

<div class="tab-content" id="myTabContent">
    
    <!-- ç›‘å¬è´¦å·ç®¡ç† -->
    <div class="tab-pane fade show active" id="worker">
        <div class="card mb-4">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h5>æ·»åŠ æ–°çš„ç›‘å¬è´¦å· (UserBot)</h5>
                    <p class="text-muted mb-0">ç³»ç»Ÿå°†ä½¿ç”¨æ­¤è´¦å·åŠ å…¥ç¾¤ç»„å¹¶æ•è·æ¶ˆæ¯ã€‚éœ€æ‰«ç ç™»å½•ã€‚</p>
                </div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">+ æ·»åŠ è´¦å·</button>
            </div>
        </div>
        
        <div class="row">
            {% for bot in workers %}
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h5>{{ bot.phone }}</h5>
                            <span class="badge bg-success">åœ¨çº¿</span>
                        </div>
                        <p class="small text-muted">Session ID: {{ bot.id }}</p>
                        <button class="btn btn-sm btn-outline-danger w-100" onclick="deleteSession('{{ bot.phone }}')">ä¸‹çº¿ / åˆ é™¤</button>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ç§ä¿¡è´¦å·ç®¡ç† -->
    <div class="tab-pane fade" id="dm">
        <div class="alert alert-info">æ­¤å¤„å±•ç¤ºç”¨æˆ·æäº¤çš„ç§ä¿¡å°å·ï¼Œç®¡ç†å‘˜å¯ååŠ©é‡æ–°éªŒè¯ã€‚</div>
        <table class="table">
            <thead><tr><th>æ‰€å±ç”¨æˆ·</th><th>è´¦å·æ‰‹æœº</th><th>çŠ¶æ€</th><th>ä»Šæ—¥é™é¢</th><th>æ“ä½œ</th></tr></thead>
            <tbody>
                <!-- æ•°æ®å¡«å……åŒº -->
            </tbody>
        </table>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† (æ ¸å¿ƒåŠŸèƒ½) -->
<div class="modal fade" id="loginModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç™»å½• Telegram è´¦å·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="loginForm">
                    <div class="mb-3">
                        <label>æ‰‹æœºå· (å¸¦åŒºå·, å¦‚ +1740...)</label>
                        <!-- ç»™æŒ‰é’®åŠ äº† id="phone" -->
                        <input type="text" class="form-control" id="phone" required placeholder="+1234567890">
                    </div>
                    <div class="d-grid mb-3">
                        <!-- âš ï¸ å…³é”®ä¿®æ”¹ï¼šå»æ‰äº† onclick="alert..."ï¼ŒåŠ äº† id="btnSendCode" -->
                        <button type="button" class="btn btn-primary" id="btnSendCode">å‘é€éªŒè¯ç </button>
                    </div>
                    <div class="mb-3">
                        <label>éªŒè¯ç  (OTP)</label>
                        <input type="text" class="form-control" id="code" placeholder="è¾“å…¥TGæ”¶åˆ°çš„5ä½æ•°å­—">
                    </div>
                    <div class="mb-3">
                        <label>ä¸¤æ­¥éªŒè¯å¯†ç  (å¦‚æœæœ‰)</label>
                        <input type="password" class="form-control" id="password">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <!-- åŠ äº† id="btnLogin" -->
                <button type="button" class="btn btn-success" id="btnLogin">ç™»å½•å¹¶ä¿å­˜ Session</button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript é€»è¾‘ -->
<script>
// ç»‘å®šã€å‘é€éªŒè¯ç ã€‘æŒ‰é’®
document.getElementById('btnSendCode').onclick = async function() {
    const phone = document.getElementById('phone').value;
    if(!phone) return alert("è¯·è¾“å…¥æ‰‹æœºå·ï¼ŒåŒ…å«å›½é™…åŒºå· (ä¾‹å¦‚ +1...)");
    
    // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
    const btn = this;
    btn.disabled = true;
    btn.innerText = "æ­£åœ¨è¯·æ±‚ TG æœåŠ¡å™¨...";
    
    try {
        const res = await fetch('/api/login/send_code', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: phone})
        });
        const data = await res.json();
        
        if(res.ok) {
            alert("âœ… " + data.message + "\nè¯·æŸ¥çœ‹æ‚¨çš„ Telegram å®¢æˆ·ç«¯ï¼ˆä¸æ˜¯çŸ­ä¿¡ï¼‰");
            btn.innerText = "éªŒè¯ç å·²å‘é€";
        } else {
            alert("âŒ å‘é€å¤±è´¥: " + data.detail);
            btn.disabled = false;
            btn.innerText = "å‘é€éªŒè¯ç ";
        }
    } catch(e) {
        console.error(e);
        alert("âŒ ç½‘ç»œè¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—");
        btn.disabled = false;
        btn.innerText = "å‘é€éªŒè¯ç ";
    }
};

// ç»‘å®šã€ç™»å½•ã€‘æŒ‰é’®
document.getElementById('btnLogin').onclick = async function() {
    const phone = document.getElementById('phone').value;
    const code = document.getElementById('code').value;
    const pwd = document.getElementById('password').value;
    
    if(!code) return alert("è¯·è¾“å…¥éªŒè¯ç ");
    
    const btn = this;
    btn.disabled = true;
    btn.innerText = "ç™»å½•ä¸­...";
    
    try {
        const res = await fetch('/api/login/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: phone, code: code, password: pwd})
        });
        const data = await res.json();
        
        if(res.ok) {
            if (data.status === '2fa_required') {
                alert("ğŸ”’ è¯¥è´¦å·å¼€å¯äº†ä¸¤æ­¥éªŒè¯ï¼Œè¯·è¾“å…¥å¯†ç  (Cloud Password) åå†æ¬¡ç‚¹å‡»ç™»å½•ã€‚");
                btn.disabled = false;
                btn.innerText = "ç¡®è®¤ç™»å½•";
            } else {
                alert("ğŸ‰ " + data.message);
                location.reload(); // åˆ·æ–°é¡µé¢
            }
        } else {
            alert("âŒ ç™»å½•å¤±è´¥: " + data.detail);
            btn.disabled = false;
            btn.innerText = "ç™»å½•å¹¶ä¿å­˜ Session";
        }
    } catch(e) {
        alert("ç™»å½•è¯·æ±‚å¤±è´¥");
        btn.disabled = false;
        btn.innerText = "ç™»å½•å¹¶ä¿å­˜ Session";
    }
};
// ... (ä¿ç•™ä¹‹å‰çš„ login é€»è¾‘) ...

// [æ–°å¢] åˆ é™¤è´¦å·é€»è¾‘
async function deleteSession(phone) {
    if (!confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· ${phone} å—ï¼Ÿ\nåˆ é™¤åéœ€è¦é‡æ–°æ‰«ç ç™»å½•ã€‚`)) return;

    try {
        const res = await fetch('/api/workers/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({phone: phone})
        });
        const data = await res.json();
        
        if (data.status === 'success') {
            alert("ğŸ—‘ è´¦å·å·²åˆ é™¤");
            location.reload(); // åˆ·æ–°é¡µé¢
        } else {
            alert("âŒ åˆ é™¤å¤±è´¥");
        }
    } catch (e) {
        alert("ç½‘ç»œé”™è¯¯");
    }
}
</script>
{% endblock %}